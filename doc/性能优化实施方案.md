# Joy IP 3D ç”Ÿå›¾ç³»ç»Ÿ - æ€§èƒ½ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–ï¼ˆ2025-12-30ï¼‰

### 1. å¹¶è¡Œå¤„ç†ä¼˜åŒ– âœ…
**æ–‡ä»¶**: `generation_controller.py` (ç¬¬32è¡Œ)
- `MAX_PARALLEL_WORKERS` ä» 1 æ”¹ä¸º 4
- é…ä»¶å¤„ç†å’ŒGateæ£€æŸ¥éƒ½æ”¯æŒå¹¶è¡Œ
- **é¢„æœŸæ•ˆæœ**: é…ä»¶å¤„ç† 104ç§’ â†’ 30ç§’ï¼ŒGateæ£€æŸ¥ 80ç§’ â†’ 20ç§’

### 2. AIè°ƒç”¨åˆå¹¶ä¼˜åŒ– âœ…
**æ–‡ä»¶**: `content_agent.py`
- å°†æ•æ„Ÿæ£€æŸ¥ + å…­ç»´åº¦åˆ†æ + æ™ºèƒ½è¡¥å…¨åˆå¹¶ä¸ºä¸€æ¬¡AIè°ƒç”¨
- ç§»é™¤äº† `_complete_fields_if_needed` ä¸­çš„é¢å¤–AIè°ƒç”¨
- æ·»åŠ äº† `_is_theme_request` æ–¹æ³•æ™ºèƒ½è¯†åˆ«ä¸»é¢˜ç±»éœ€æ±‚
- **é¢„æœŸæ•ˆæœ**: AIè°ƒç”¨ä»2-3æ¬¡å‡å°‘åˆ°1æ¬¡ï¼ŒèŠ‚çœçº¦20-40ç§’

### 3. åˆ†æç»“æœç¼“å­˜ âœ…
**æ–‡ä»¶**: `utils/analysis_cache.py` + `content_agent.py`
- å†…å­˜ç¼“å­˜ + æ–‡ä»¶ç¼“å­˜åŒå±‚æ¶æ„
- 24å°æ—¶TTLï¼Œæœ€å¤§100æ¡å†…å­˜ç¼“å­˜
- **é¢„æœŸæ•ˆæœ**: é‡å¤è¯·æ±‚0ç§’

### 4. CLIPæ¨¡å‹é¢„åŠ è½½ âœ…
**æ–‡ä»¶**: `utils/clip_manager.py`
- æ¨¡å—åŠ è½½æ—¶è‡ªåŠ¨å¯åŠ¨åå°é¢„åŠ è½½çº¿ç¨‹
- ä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œé¦–æ¬¡è¯·æ±‚æ—¶æ¨¡å‹å·²å°±ç»ª
- æ”¯æŒ `DISABLE_CLIP_PRELOAD=1` ç¯å¢ƒå˜é‡ç¦ç”¨
- **é¢„æœŸæ•ˆæœ**: é¦–æ¬¡è¯·æ±‚å‡å°‘çº¦8ç§’

### 5. å¹¶è¡ŒGateæ£€æŸ¥ âœ…
**æ–‡ä»¶**: `generation_controller.py`
- `_gate_check_parallel` æ–¹æ³•æ”¯æŒå¤šå›¾ç‰‡å¹¶è¡Œæ£€æŸ¥
- ä½¿ç”¨ `MAX_PARALLEL_WORKERS` æ§åˆ¶å¹¶å‘æ•°
- **é¢„æœŸæ•ˆæœ**: Gateæ£€æŸ¥ 80ç§’ â†’ 20ç§’

---

## ğŸ“Š å½“å‰æ€§èƒ½åŸºçº¿

åŸºäºçœŸå®ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆç”¨ä¾‹ï¼š"é¡¶ç€å¸¦å°é“ƒé“›çš„æ·±è“è´é›·å¸½ï¼Œç©¿ç€çº¢è‰²æ³•å…°ç»’è¡¬è¡«å¤–å¥—ï¼Œæ‰‹æŒæ•£å‘æš–å…‰çš„æ¾æœé­”æ³•æ£’"ï¼‰

| é˜¶æ®µ | å½“å‰ç”¨æ—¶ | å æ¯” | ä¼˜å…ˆçº§ |
|------|----------|------|--------|
| 1. ç³»ç»Ÿåˆå§‹åŒ– | 3.89ç§’ | 1.5% | ä½ |
| 2. è¿è§„è¯æ£€æŸ¥ | 0.00ç§’ | 0% | - |
| 3. AIæ•æ„Ÿå†…å®¹æ£€æŸ¥ | 17.28ç§’ | 6.6% | ä¸­ |
| 4. AIå†…å®¹åˆ†æ | 37.57ç§’ | 14.4% | é«˜ |
| 5. è¡¨æƒ…åŠ¨ä½œåˆ†æ | 12.61ç§’ | 4.8% | ä¸­ |
| 6. åŸºç¡€å›¾ç‰‡ç”Ÿæˆ | 22.01ç§’ | 8.4% | ä¸­ |
| 7. ç»Ÿä¸€é…ä»¶å¤„ç† | 104.47ç§’ | 40.0% | **æœ€é«˜** |
| 8. Gateè´¨é‡æ£€æŸ¥ | ~80ç§’ | 30.6% | é«˜ |
| **æ€»è®¡** | **~260ç§’** | 100% | - |

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

- **çŸ­æœŸç›®æ ‡**ï¼ˆ1å‘¨å†…ï¼‰ï¼šæ€»ç”¨æ—¶ä»260ç§’é™è‡³150ç§’ï¼ˆ-42%ï¼‰
- **ä¸­æœŸç›®æ ‡**ï¼ˆ2å‘¨å†…ï¼‰ï¼šæ€»ç”¨æ—¶ä»150ç§’é™è‡³90ç§’ï¼ˆ-65%ï¼‰
- **é•¿æœŸç›®æ ‡**ï¼ˆ1ä¸ªæœˆå†…ï¼‰ï¼šæ€»ç”¨æ—¶ä»90ç§’é™è‡³60ç§’ï¼ˆ-77%ï¼‰

---

## ğŸ“‹ ä¼˜åŒ–æ–¹æ¡ˆè¯¦è§£

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šç»Ÿä¸€é…ä»¶å¤„ç†ä¼˜åŒ–ï¼ˆ104.47ç§’ â†’ 30ç§’ï¼‰

#### é—®é¢˜åˆ†æ
- å½“å‰4å¼ å›¾ç‰‡ä¸²è¡Œå¤„ç†ï¼Œæ¯å¼ çº¦26ç§’
- `MAX_PARALLEL_WORKERS=1`ï¼Œæœªå¯ç”¨å¹¶è¡Œ
- æ¯æ¬¡APIè°ƒç”¨éƒ½æ˜¯ç‹¬ç«‹çš„HTTPè¯·æ±‚

#### ä¼˜åŒ–æ–¹æ¡ˆ1.1ï¼šå¯ç”¨å¹¶è¡Œå¤„ç†ï¼ˆç«‹å³å¯æ‰§è¡Œï¼‰

**ä¿®æ”¹æ–‡ä»¶**: `generation_controller.py`

```python
# å½“å‰é…ç½®ï¼ˆç¬¬26è¡Œé™„è¿‘ï¼‰
MAX_PARALLEL_WORKERS = int(os.environ.get("MAX_PARALLEL_WORKERS", "1"))

# ä¿®æ”¹ä¸º
MAX_PARALLEL_WORKERS = int(os.environ.get("MAX_PARALLEL_WORKERS", "4"))
```

**æˆ–è€…é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®**:
```bash
# Windows
set MAX_PARALLEL_WORKERS=4

# Linux/Mac
export MAX_PARALLEL_WORKERS=4
```

**é¢„æœŸæ•ˆæœ**: 104ç§’ â†’ 30ç§’ï¼ˆ4å¼ å›¾ç‰‡å¹¶è¡Œå¤„ç†ï¼Œå–æœ€é•¿å•å¼ æ—¶é—´ï¼‰

#### ä¼˜åŒ–æ–¹æ¡ˆ1.2ï¼šå‡å°‘ç”Ÿæˆå›¾ç‰‡æ•°é‡

**ä¿®æ”¹æ–‡ä»¶**: `image_processor.py`

```python
# å½“å‰é…ç½®ï¼ˆç¬¬65è¡Œé™„è¿‘ï¼‰
self.body_count_mapping = {
    "ç«™å§¿": 2,  # æ”¹ä¸º1
    "æ¬¢å¿«": 2,  # æ”¹ä¸º1
    "åå§¿": 2,  # æ”¹ä¸º1
    "è·³è·ƒ": 1,
    "è·‘åŠ¨": 2   # æ”¹ä¸º1
}
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘50%çš„å›¾ç‰‡å¤„ç†é‡

#### ä¼˜åŒ–æ–¹æ¡ˆ1.3ï¼šä¼˜åŒ–Prompté•¿åº¦

**ä¿®æ”¹æ–‡ä»¶**: `prompt_templates.py`

å½“å‰Promptçº¦800å­—ç¬¦ï¼Œå¯ä»¥ç²¾ç®€åˆ°400å­—ç¬¦ï¼š

```python
# æ·»åŠ ç²¾ç®€ç‰ˆç³»ç»Ÿæç¤ºè¯
SYSTEM_PROMPTS['minimal'] = """ä½ æ˜¯å›¾åƒç¼–è¾‘AIï¼Œä¸ºå¡é€šè§’è‰²æ·»åŠ é…ä»¶ã€‚
è§„åˆ™ï¼š
1. ä¿æŒè§’è‰²åŠ¨ä½œã€è¡¨æƒ…ä¸å˜
2. åªæ·»åŠ æŒ‡å®šé…ä»¶
3. é…ä»¶æ¯”ä¾‹åè°ƒ"""

# æ·»åŠ ç²¾ç®€ç‰ˆçº¦æŸ
CONSTRAINTS['minimal'] = [
    "ä¸æ”¹å˜è§’è‰²å§¿æ€",
    "ä¸æ·»åŠ å¥³æ€§åŒ–é…ä»¶",
    "ä¿æŒèƒŒæ™¯çº¯è‰²"
]
```

**ä¿®æ”¹æ–‡ä»¶**: `banana-pro-img-jd.py`

```python
def generate_image_with_accessories(image_path, accessories_info, style="minimal"):
    # ä½¿ç”¨ç²¾ç®€ç‰ˆprompt
    ...
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘tokenæ¶ˆè€—ï¼ŒAPIå“åº”æ—¶é—´å‡å°‘çº¦20%

---

### ç¬¬äºŒä¼˜å…ˆçº§ï¼šGateè´¨é‡æ£€æŸ¥ä¼˜åŒ–ï¼ˆ80ç§’ â†’ 20ç§’ï¼‰

#### é—®é¢˜åˆ†æ
- å½“å‰4å¼ å›¾ç‰‡ä¸²è¡Œæ£€æŸ¥
- æ¯å¼ å›¾ç‰‡è°ƒç”¨AIæ¨¡å‹æ£€æŸ¥çº¦20ç§’
- `MAX_PARALLEL_WORKERS=1`

#### ä¼˜åŒ–æ–¹æ¡ˆ2.1ï¼šå¯ç”¨å¹¶è¡ŒGateæ£€æŸ¥

**ä¿®æ”¹æ–‡ä»¶**: `generation_controller.py`

Gateæ£€æŸ¥å·²ç»æ”¯æŒå¹¶è¡Œï¼Œåªéœ€è¦å¢åŠ workersæ•°é‡ï¼ˆåŒæ–¹æ¡ˆ1.1ï¼‰

**é¢„æœŸæ•ˆæœ**: 80ç§’ â†’ 20ç§’

#### ä¼˜åŒ–æ–¹æ¡ˆ2.2ï¼šæ™ºèƒ½è·³è¿‡æ£€æŸ¥

**ä¿®æ”¹æ–‡ä»¶**: `generation_controller.py`

```python
def final_gate_check(self, image_paths: List[str]) -> List[str]:
    """æœ€ç»ˆ Gate æ£€æŸ¥"""
    
    # æ–°å¢ï¼šå¦‚æœå›¾ç‰‡æ•°é‡å°‘äºç­‰äº2å¼ ï¼Œè·³è¿‡æ£€æŸ¥
    if len(image_paths) <= 2:
        logger.info("[FinalGate] å›¾ç‰‡æ•°é‡è¾ƒå°‘ï¼Œè·³è¿‡æ£€æŸ¥")
        return image_paths
    
    # æ–°å¢ï¼šéšæœºæŠ½æ ·æ£€æŸ¥ï¼ˆå½“å›¾ç‰‡æ•°é‡å¤§äº4æ—¶ï¼‰
    if len(image_paths) > 4:
        import random
        sample_size = min(4, len(image_paths))
        sample_indices = random.sample(range(len(image_paths)), sample_size)
        sample_paths = [image_paths[i] for i in sample_indices]
        
        # åªæ£€æŸ¥æŠ½æ ·çš„å›¾ç‰‡
        passed_samples = self._gate_check_parallel(sample_paths, logger.info)
        
        # å¦‚æœæŠ½æ ·å…¨éƒ¨é€šè¿‡ï¼Œè¿”å›æ‰€æœ‰å›¾ç‰‡
        if len(passed_samples) == len(sample_paths):
            return image_paths
        else:
            # å¦åˆ™è¿›è¡Œå®Œæ•´æ£€æŸ¥
            return self._gate_check_parallel(image_paths, logger.info)
    
    # åŸæœ‰é€»è¾‘...
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘50%çš„æ£€æŸ¥æ¬¡æ•°

#### ä¼˜åŒ–æ–¹æ¡ˆ2.3ï¼šç¦ç”¨Gateæ£€æŸ¥ï¼ˆå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼‰

**é€šè¿‡ç¯å¢ƒå˜é‡æ§åˆ¶**:
```bash
# ç¦ç”¨Gateæ£€æŸ¥
set ENABLE_GATE_CHECK=0

# æˆ–è€…åªæ£€æŸ¥å¤´æˆ´
set GATE_CHECK_SCOPE=hats
```

**é¢„æœŸæ•ˆæœ**: 80ç§’ â†’ 0ç§’ï¼ˆä»…é™å¼€å‘ç¯å¢ƒï¼‰

---

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šAIå†…å®¹åˆ†æä¼˜åŒ–ï¼ˆ37.57ç§’ â†’ 15ç§’ï¼‰

#### é—®é¢˜åˆ†æ
- å½“å‰è¿›è¡Œ2æ¬¡AIè°ƒç”¨ï¼ˆä¸»åˆ†æ + ä¸‹è£…è¡¥å…¨ï¼‰
- æ¯æ¬¡è°ƒç”¨çº¦15-20ç§’
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶

#### ä¼˜åŒ–æ–¹æ¡ˆ3.1ï¼šåˆå¹¶AIè°ƒç”¨

**ä¿®æ”¹æ–‡ä»¶**: `content_agent.py`

```python
def _analyze_content_combined(self, requirement: str) -> Dict[str, str]:
    """åˆå¹¶åˆ†æï¼šä¸€æ¬¡AIè°ƒç”¨å®Œæˆæ‰€æœ‰åˆ†æ"""
    
    # ä¿®æ”¹promptï¼Œè¦æ±‚AIä¸€æ¬¡æ€§è¿”å›å®Œæ•´ç»“æœï¼ˆåŒ…æ‹¬ä¸‹è£…è¡¥å…¨ï¼‰
    prompt = f"""åˆ†æä»¥ä¸‹ç”¨æˆ·éœ€æ±‚ï¼Œæå–å…­ä¸ªç»´åº¦çš„ä¿¡æ¯ã€‚
å¦‚æœç”¨æˆ·åªæåˆ°ä¸Šè£…æ²¡æœ‰æåˆ°ä¸‹è£…ï¼Œè¯·æ ¹æ®ä¸Šè£…é£æ ¼è‡ªåŠ¨è¡¥å…¨ä¸€ä¸ªåˆé€‚çš„ä¸‹è£…ã€‚

ç”¨æˆ·éœ€æ±‚ï¼š{requirement}

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¿”å›ï¼ˆæ¯è¡Œä¸€ä¸ªå­—æ®µï¼‰ï¼š
åˆè§„ï¼šæ˜¯/å¦
ä¸åˆè§„åŸå› ï¼šæ— /å…·ä½“åŸå› 
è¡¨æƒ…ï¼šå…·ä½“è¡¨æƒ…æˆ–æ— 
ä¸Šè£…ï¼šå…·ä½“æè¿°æˆ–æ— 
ä¸‹è£…ï¼šå…·ä½“æè¿°æˆ–æ— ï¼ˆå¦‚ç”¨æˆ·æœªæåŠï¼Œè¯·æ ¹æ®ä¸Šè£…é£æ ¼è¡¥å…¨ï¼‰
å¤´æˆ´ï¼šå…·ä½“æè¿°æˆ–æ— 
æ‰‹æŒï¼šå…·ä½“æè¿°æˆ–æ— """
    
    # ä¸€æ¬¡è°ƒç”¨å®Œæˆæ‰€æœ‰åˆ†æ
    response = self._call_ai(prompt)
    
    # è§£æç»“æœ...
```

**é¢„æœŸæ•ˆæœ**: 37ç§’ â†’ 18ç§’ï¼ˆå‡å°‘ä¸€æ¬¡AIè°ƒç”¨ï¼‰

#### ä¼˜åŒ–æ–¹æ¡ˆ3.2ï¼šå®ç°ç¼“å­˜æœºåˆ¶

**æ–°å»ºæ–‡ä»¶**: `utils/analysis_cache.py`

```python
import hashlib
import json
import os
from typing import Dict, Optional
from datetime import datetime, timedelta

class AnalysisCache:
    """åˆ†æç»“æœç¼“å­˜"""
    
    def __init__(self, cache_dir: str = "cache/analysis", ttl_hours: int = 24):
        self.cache_dir = cache_dir
        self.ttl = timedelta(hours=ttl_hours)
        os.makedirs(cache_dir, exist_ok=True)
    
    def _get_cache_key(self, requirement: str) -> str:
        """ç”Ÿæˆç¼“å­˜é”®"""
        return hashlib.md5(requirement.encode()).hexdigest()
    
    def _get_cache_path(self, key: str) -> str:
        """è·å–ç¼“å­˜æ–‡ä»¶è·¯å¾„"""
        return os.path.join(self.cache_dir, f"{key}.json")
    
    def get(self, requirement: str) -> Optional[Dict]:
        """è·å–ç¼“å­˜"""
        key = self._get_cache_key(requirement)
        path = self._get_cache_path(key)
        
        if not os.path.exists(path):
            return None
        
        try:
            with open(path, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            cached_time = datetime.fromisoformat(data['timestamp'])
            if datetime.now() - cached_time > self.ttl:
                os.remove(path)
                return None
            
            return data['analysis']
        except Exception:
            return None
    
    def set(self, requirement: str, analysis: Dict):
        """è®¾ç½®ç¼“å­˜"""
        key = self._get_cache_key(requirement)
        path = self._get_cache_path(key)
        
        data = {
            'requirement': requirement,
            'analysis': analysis,
            'timestamp': datetime.now().isoformat()
        }
        
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

# å…¨å±€ç¼“å­˜å®ä¾‹
analysis_cache = AnalysisCache()
```

**ä¿®æ”¹æ–‡ä»¶**: `content_agent.py`

```python
from utils.analysis_cache import analysis_cache

def _analyze_content_combined(self, requirement: str) -> Dict[str, str]:
    """åˆå¹¶åˆ†æå†…å®¹ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
    
    # å…ˆæ£€æŸ¥ç¼“å­˜
    cached = analysis_cache.get(requirement)
    if cached:
        logger.info(f"å‘½ä¸­ç¼“å­˜ï¼Œè·³è¿‡AIåˆ†æ")
        return cached
    
    # æ‰§è¡ŒAIåˆ†æ
    analysis = self._do_analyze(requirement)
    
    # å­˜å…¥ç¼“å­˜
    analysis_cache.set(requirement, analysis)
    
    return analysis
```

**é¢„æœŸæ•ˆæœ**: é‡å¤è¯·æ±‚0ç§’ï¼Œé¦–æ¬¡è¯·æ±‚18ç§’

---

### ç¬¬å››ä¼˜å…ˆçº§ï¼šAIæ•æ„Ÿå†…å®¹æ£€æŸ¥ä¼˜åŒ–ï¼ˆ17.28ç§’ â†’ 0ç§’ï¼‰

#### é—®é¢˜åˆ†æ
- æ•æ„Ÿæ£€æŸ¥å’Œå†…å®¹åˆ†ææ˜¯ä¸¤æ¬¡ç‹¬ç«‹çš„AIè°ƒç”¨
- å¯ä»¥åˆå¹¶ä¸ºä¸€æ¬¡è°ƒç”¨

#### ä¼˜åŒ–æ–¹æ¡ˆ4.1ï¼šåˆå¹¶æ•æ„Ÿæ£€æŸ¥åˆ°å†…å®¹åˆ†æ

**ä¿®æ”¹æ–‡ä»¶**: `content_agent.py`

å½“å‰çš„ `_analyze_content_combined` å·²ç»åŒ…å«äº†åˆè§„æ£€æŸ¥ï¼Œå¯ä»¥ç§»é™¤å•ç‹¬çš„æ•æ„Ÿæ£€æŸ¥ï¼š

```python
def process_content(self, requirement: str) -> Dict:
    """å¤„ç†ç”¨æˆ·è¾“å…¥å†…å®¹"""
    
    # 1. è¿è§„è¯æ£€æŸ¥ï¼ˆæœ¬åœ°ï¼Œ0ç§’ï¼‰
    is_compliant, reason = self._check_external_banned_words(requirement)
    if not is_compliant:
        return {'compliant': False, 'reason': reason, 'analysis': {}}
    
    # 2. åˆå¹¶åˆ†æï¼ˆåŒ…å«æ•æ„Ÿæ£€æŸ¥ + å…­ç»´åº¦åˆ†æï¼‰
    # ç§»é™¤å•ç‹¬çš„ _check_sensitive_content_with_ai è°ƒç”¨
    analysis = self._analyze_content_combined(requirement)
    
    # æ£€æŸ¥åˆå¹¶åˆ†æä¸­çš„åˆè§„ç»“æœ
    if analysis.get('_compliant') == False:
        return {'compliant': False, 'reason': analysis.get('_reason', 'å†…å®¹ä¸åˆè§„'), 'analysis': {}}
    
    return {'compliant': True, 'reason': '', 'analysis': analysis}
```

**é¢„æœŸæ•ˆæœ**: 17ç§’ â†’ 0ç§’ï¼ˆåˆå¹¶åˆ°å†…å®¹åˆ†æä¸­ï¼‰

---

### ç¬¬äº”ä¼˜å…ˆçº§ï¼šè¡¨æƒ…åŠ¨ä½œåˆ†æä¼˜åŒ–ï¼ˆ12.61ç§’ â†’ 1ç§’ï¼‰

#### é—®é¢˜åˆ†æ
- å½“å‰ä½¿ç”¨AIè¿›è¡ŒåŠ¨ä½œåˆ†ç±»
- å¤§éƒ¨åˆ†åŠ¨ä½œå¯ä»¥é€šè¿‡å…³é”®è¯åŒ¹é…

#### ä¼˜åŒ–æ–¹æ¡ˆ5.1ï¼šæ‰©å±•æœ¬åœ°å…³é”®è¯åº“

**ä¿®æ”¹æ–‡ä»¶**: `matchers/body_matcher.py`

```python
class BodyMatcher:
    def __init__(self):
        # æ‰©å±•å…³é”®è¯åº“
        self.action_keywords = {
            "ç«™å§¿": ["ç«™", "ç«‹", "ç«™ç«‹", "ç«™ç€", "ç›´ç«‹", "æŒºç«‹", "ä¼«ç«‹", "çŸ—ç«‹"],
            "åå§¿": ["å", "åç€", "åä¸‹", "ç«¯å", "ç›˜å", "è¹²", "è¹²ç€"],
            "è·³è·ƒ": ["è·³", "è·³è·ƒ", "è¹¦", "è¹¦è·³", "è·ƒèµ·", "è…¾ç©º", "é£è·ƒ"],
            "è·‘åŠ¨": ["è·‘", "è·‘æ­¥", "å¥”è·‘", "å¿«è·‘", "å†²åˆº", "ç–¾è·‘", "é£å¥”"],
            "æ¬¢å¿«": ["æ¬¢å¿«", "å¼€å¿ƒ", "é«˜å…´", "å¿«ä¹", "å…´å¥‹", "é›€è·ƒ", "æ¬¢ä¹", "æ„‰å¿«"]
        }
    
    def classify_action_type(self, requirement: str) -> str:
        """åˆ†ç±»åŠ¨ä½œç±»å‹ï¼ˆä¼˜å…ˆæœ¬åœ°åŒ¹é…ï¼‰"""
        
        # 1. æœ¬åœ°å…³é”®è¯åŒ¹é…
        for action_type, keywords in self.action_keywords.items():
            for keyword in keywords:
                if keyword in requirement:
                    logger.info(f"æœ¬åœ°åŒ¹é…åˆ°åŠ¨ä½œç±»å‹: {action_type} (å…³é”®è¯: {keyword})")
                    return action_type
        
        # 2. åªæœ‰åœ¨æœ¬åœ°åŒ¹é…å¤±è´¥æ—¶æ‰è°ƒç”¨AI
        logger.info("æœ¬åœ°åŒ¹é…å¤±è´¥ï¼Œè°ƒç”¨AIåˆ†æ")
        return self._classify_with_ai(requirement)
```

**é¢„æœŸæ•ˆæœ**: 90%çš„è¯·æ±‚å¯ä»¥æœ¬åœ°åŒ¹é…ï¼Œ12ç§’ â†’ 1ç§’

---

### ç¬¬å…­ä¼˜å…ˆçº§ï¼šåŸºç¡€å›¾ç‰‡ç”Ÿæˆä¼˜åŒ–ï¼ˆ22.01ç§’ â†’ 10ç§’ï¼‰

#### é—®é¢˜åˆ†æ
- CLIPæ¨¡å‹é¦–æ¬¡åŠ è½½è€—æ—¶çº¦8ç§’
- å›¾ç‰‡åˆæˆè¿‡ç¨‹çº¦14ç§’

#### ä¼˜åŒ–æ–¹æ¡ˆ6.1ï¼šé¢„åŠ è½½CLIPæ¨¡å‹

**ä¿®æ”¹æ–‡ä»¶**: `matchers/head_matcher.py`

```python
# åœ¨æ¨¡å—åŠ è½½æ—¶é¢„çƒ­CLIPæ¨¡å‹
import threading

def _preload_clip():
    """åå°é¢„åŠ è½½CLIPæ¨¡å‹"""
    try:
        from sentence_transformers import SentenceTransformer
        global _clip_model
        _clip_model = SentenceTransformer('clip-ViT-B-32')
        logger.info("CLIPæ¨¡å‹é¢„åŠ è½½å®Œæˆ")
    except Exception as e:
        logger.warning(f"CLIPæ¨¡å‹é¢„åŠ è½½å¤±è´¥: {e}")

# å¯åŠ¨åå°é¢„åŠ è½½
_preload_thread = threading.Thread(target=_preload_clip, daemon=True)
_preload_thread.start()
```

**é¢„æœŸæ•ˆæœ**: é¦–æ¬¡è¯·æ±‚å‡å°‘8ç§’

#### ä¼˜åŒ–æ–¹æ¡ˆ6.2ï¼šå‡å°‘å›¾ç‰‡ç»„åˆæ•°é‡

**ä¿®æ”¹æ–‡ä»¶**: `image_processor.py`

```python
def combine_images(self, body_images: List[str], head_images: List[Dict], 
                  action_type: str, output_dir: str = "output", 
                  max_combinations: int = 2) -> List[str]:  # æ–°å¢å‚æ•°
    """ç»„åˆèº«ä½“å’Œå¤´åƒå›¾ç‰‡ï¼ˆé™åˆ¶ç»„åˆæ•°é‡ï¼‰"""
    
    combined_images = []
    combination_count = 0
    
    for i, body_path in enumerate(body_images):
        for j, head_data in enumerate(head_images):
            if combination_count >= max_combinations:
                break
            
            # ç»„åˆé€»è¾‘...
            combination_count += 1
        
        if combination_count >= max_combinations:
            break
    
    return combined_images
```

**é¢„æœŸæ•ˆæœ**: å‡å°‘50%çš„ç»„åˆå¤„ç†æ—¶é—´

---

### ç¬¬ä¸ƒä¼˜å…ˆçº§ï¼šç³»ç»Ÿåˆå§‹åŒ–ä¼˜åŒ–ï¼ˆ3.89ç§’ â†’ 1ç§’ï¼‰

#### ä¼˜åŒ–æ–¹æ¡ˆ7.1ï¼šå»¶è¿ŸåŠ è½½éå¿…éœ€æ¨¡å—

**ä¿®æ”¹æ–‡ä»¶**: `generation_controller.py`

```python
class GenerationController:
    def __init__(self):
        self.max_retries = 1
        self.content_agent = ContentAgent()
        
        # å»¶è¿ŸåŠ è½½æ¨¡å—
        self._banana_unified = None
        self._gate_check = None
    
    @property
    def banana_unified(self):
        """å»¶è¿ŸåŠ è½½banana_unifiedæ¨¡å—"""
        if self._banana_unified is None:
            self._banana_unified = ModuleLoader.load('banana-pro-img-jd.py')
        return self._banana_unified
    
    @property
    def gate_check(self):
        """å»¶è¿ŸåŠ è½½gate_checkæ¨¡å—"""
        if self._gate_check is None:
            self._gate_check = ModuleLoader.load('gate-result.py')
        return self._gate_check
```

**é¢„æœŸæ•ˆæœ**: åˆå§‹åŒ–æ—¶é—´å‡å°‘çº¦2ç§’

---

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœé¢„ä¼°

### çŸ­æœŸä¼˜åŒ–ï¼ˆ1å‘¨å†…å®æ–½ï¼‰

| ä¼˜åŒ–é¡¹ | å½“å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|--------|------|--------|------|
| å¯ç”¨å¹¶è¡Œå¤„ç† | 104ç§’ | 30ç§’ | 74ç§’ |
| å¯ç”¨å¹¶è¡ŒGate | 80ç§’ | 20ç§’ | 60ç§’ |
| åˆå¹¶AIè°ƒç”¨ | 55ç§’ | 18ç§’ | 37ç§’ |
| æ‰©å±•å…³é”®è¯åº“ | 13ç§’ | 1ç§’ | 12ç§’ |
| **æ€»è®¡** | **260ç§’** | **77ç§’** | **183ç§’** |

### ä¸­æœŸä¼˜åŒ–ï¼ˆ2å‘¨å†…å®æ–½ï¼‰

| ä¼˜åŒ–é¡¹ | å½“å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|--------|------|--------|------|
| å®ç°ç¼“å­˜æœºåˆ¶ | 18ç§’ | 0ç§’* | 18ç§’ |
| é¢„åŠ è½½CLIP | 22ç§’ | 14ç§’ | 8ç§’ |
| ç²¾ç®€Prompt | 30ç§’ | 24ç§’ | 6ç§’ |
| **æ€»è®¡** | **77ç§’** | **45ç§’** | **32ç§’** |

*ç¼“å­˜å‘½ä¸­æ—¶

---

## ğŸš€ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šç«‹å³å®æ–½ï¼ˆä»Šå¤©ï¼‰

1. **ä¿®æ”¹ç¯å¢ƒå˜é‡**
   ```bash
   set MAX_PARALLEL_WORKERS=4
   ```

2. **ä¿®æ”¹ `generation_controller.py` ç¬¬26è¡Œ**
   ```python
   MAX_PARALLEL_WORKERS = int(os.environ.get("MAX_PARALLEL_WORKERS", "4"))
   ```

### ç¬¬äºŒé˜¶æ®µï¼šæœ¬å‘¨å®æ–½

1. åˆå¹¶AIæ•æ„Ÿæ£€æŸ¥åˆ°å†…å®¹åˆ†æ
2. æ‰©å±•æœ¬åœ°å…³é”®è¯åº“
3. å®ç°åˆ†æç»“æœç¼“å­˜

### ç¬¬ä¸‰é˜¶æ®µï¼šä¸‹å‘¨å®æ–½

1. ç²¾ç®€Promptæ¨¡æ¿
2. é¢„åŠ è½½CLIPæ¨¡å‹
3. ä¼˜åŒ–å›¾ç‰‡ç»„åˆé€»è¾‘

### ç¬¬å››é˜¶æ®µï¼šæŒç»­ä¼˜åŒ–

1. ç›‘æ§æ€§èƒ½æŒ‡æ ‡
2. æ ¹æ®å®é™…æ•°æ®è°ƒæ•´å‚æ•°
3. è€ƒè™‘æ›´å¿«çš„AIæ¨¡å‹

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

å»ºè®®æ·»åŠ ä»¥ä¸‹ç›‘æ§ï¼š

```python
# åœ¨å„ä¸ªå…³é”®ç¯èŠ‚æ·»åŠ è®¡æ—¶æ—¥å¿—
import time

class PerformanceMonitor:
    @staticmethod
    def log_stage(stage_name: str, duration: float):
        logger.info(f"[æ€§èƒ½ç›‘æ§] {stage_name}: {duration:.2f}ç§’")
    
    @staticmethod
    def time_it(func):
        """è£…é¥°å™¨ï¼šè‡ªåŠ¨è®°å½•å‡½æ•°æ‰§è¡Œæ—¶é—´"""
        def wrapper(*args, **kwargs):
            start = time.time()
            result = func(*args, **kwargs)
            duration = time.time() - start
            PerformanceMonitor.log_stage(func.__name__, duration)
            return result
        return wrapper
```

---

## âœ… éªŒæ”¶æ ‡å‡†

1. **çŸ­æœŸç›®æ ‡éªŒæ”¶**
   - æ€»ç”¨æ—¶ < 150ç§’
   - å¹¶è¡Œå¤„ç†æ­£å¸¸å·¥ä½œ
   - æ— åŠŸèƒ½å›å½’

2. **ä¸­æœŸç›®æ ‡éªŒæ”¶**
   - æ€»ç”¨æ—¶ < 90ç§’
   - ç¼“å­˜å‘½ä¸­ç‡ > 30%
   - ç³»ç»Ÿç¨³å®šæ€§ > 99%

3. **é•¿æœŸç›®æ ‡éªŒæ”¶**
   - æ€»ç”¨æ—¶ < 60ç§’
   - ç”¨æˆ·æ»¡æ„åº¦æå‡
   - APIæˆæœ¬é™ä½ > 30%
