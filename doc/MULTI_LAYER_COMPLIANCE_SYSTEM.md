# 多层内容合规检查系统

## 概述

本系统实现了三层递进式内容合规检查，确保生成的图片内容符合规范要求，特别是对宗教、政治、民族、国家等敏感内容进行严格筛选。

## 检查层级

### 第一层：违规词库检查
- **功能**：基于预定义的违规词库进行快速匹配
- **检查内容**：
  - 普通违规词汇（如：裙、女、暴力、色情等）
  - 正则表达式匹配（如：`REGEX:女(?!孩|生|士|性)`）
- **优势**：速度快，准确率高
- **配置文件**：`data/sensitive_words.txt`

### 第二层：敏感内容AI检查
- **功能**：使用大模型专门检测宗教、政治、民族、国家相关敏感内容
- **检查重点**：
  1. **宗教相关**：宗教符号、宗教人物、宗教建筑、宗教仪式
  2. **政治相关**：政治人物、政治事件、政治制度、政治口号
  3. **民族相关**：特定民族服饰、民族文化、民族冲突
  4. **国家相关**：国旗、国徽、具体国家政治象征
- **策略**：严格检查，安全优先

### 第三层：通用违规AI检查
- **功能**：检查除敏感内容外的其他违规内容
- **检查重点**：
  1. 暴力内容：暴力行为、血腥场面、武器使用
  2. 色情内容：性暗示、裸体、情色描述
  3. 毒品相关：吸毒、贩毒、毒品制造
  4. 赌博相关：赌博行为、博彩活动
  5. 违法犯罪：盗窃、诈骗、其他犯罪行为
  6. 自残自杀：自杀、自残、抑郁等负面内容
  7. 歧视仇恨：基于性别、年龄等的歧视言论

## 工作流程

```
用户输入 → 第一层检查 → 第二层检查 → 第三层检查 → 生成图片
    ↓           ↓           ↓           ↓
  内容分析   违规词库检查  敏感内容AI检查  通用违规AI检查
    ↓           ↓           ↓           ↓
   通过      通过/拒绝    通过/拒绝    通过/拒绝
```

## 检查示例

### ✅ 通过的内容
```json
{
  "表情": "开心",
  "动作": "站姿",
  "服装": "蓝色上衣",
  "手拿": "书本",
  "头戴": "棒球帽"
}
```

### ❌ 被拒绝的内容

#### 违规词库检查拒绝
```json
{
  "表情": "开心",
  "服装": "裙子"  // 包含违规词"裙"
}
```

#### 敏感内容AI检查拒绝
```json
{
  "表情": "虔诚",
  "服装": "僧袍",    // 宗教服饰
  "手拿": "佛珠"     // 宗教符号
}
```

#### 通用违规AI检查拒绝
```json
{
  "表情": "愤怒",
  "动作": "打斗",
  "手拿": "刀",      // 暴力内容
  "背景": "战场"
}
```

## 技术实现

### 核心文件
- `content_agent.py`：内容合规检查核心逻辑
- `generation_controller.py`：图片生成流程控制
- `data/sensitive_words.txt`：违规词库文件

### 关键方法
- `ContentAgent.check_compliance()`：主检查入口
- `ContentAgent._check_external_banned_words()`：违规词库检查
- `ContentAgent._check_sensitive_content_with_ai()`：敏感内容AI检查
- `GenerationController.check_content_compliance()`：生成流程中的合规检查

## 配置说明

### 违规词库配置
文件：`data/sensitive_words.txt`
```
# 普通违规词
女
裙
暴力

# 正则表达式
REGEX:女(?!孩|生|士|性)
```

### AI检查配置
- 模型：Gemini-2.5-pro
- API：京东云模型服务
- 超时：60秒
- 错误处理：网络错误时默认拒绝（安全优先）

## 测试验证

运行测试文件验证系统功能：
```bash
python test_sensitive_content.py
python test_banned_words.py
```

## 安全策略

1. **多层防护**：三层检查确保无遗漏
2. **安全优先**：检查失败时默认拒绝
3. **严格标准**：对敏感内容采用严格检查标准
4. **实时更新**：支持动态添加/删除违规词
5. **详细日志**：提供详细的检查过程和拒绝原因

## 性能优化

1. **分层检查**：先快速检查，再深度检查
2. **缓存机制**：违规词库一次加载，多次使用
3. **并发控制**：AI检查设置合理超时
4. **错误恢复**：单层检查失败不影响其他层级

## 维护指南

### 添加违规词
```python
agent = ContentAgent()
agent.add_banned_word("新违规词")
agent.add_banned_word("REGEX:正则表达式")
```

### 移除违规词
```python
agent.remove_banned_word("违规词")
```

### 更新AI检查逻辑
修改 `_check_sensitive_content_with_ai()` 方法中的提示词。

## 注意事项

1. AI检查依赖网络，需确保网络连接稳定
2. 敏感内容检查较为严格，可能存在误判
3. 违规词库需要定期维护和更新
4. 系统采用安全优先策略，宁可误拒绝也不放过违规内容